{% extends "base.html" %}

{% block title %}Admin Panel - Email Guardian{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
        <li class="breadcrumb-item active">Admin Panel</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3">
                <i class="fas fa-cog text-primary me-2"></i>
                System Administration
            </h1>
            <div class="badge bg-success">
                <i class="fas fa-check-circle me-1"></i>
                System Online
            </div>
        </div>
    </div>
</div>

<!-- System Statistics -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.total_sessions }}</h4>
                        <p class="card-text">Total Sessions</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-database fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.active_sessions }}</h4>
                        <p class="card-text">Active Sessions</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-spinner fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.completed_sessions }}</h4>
                        <p class="card-text">Completed</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-danger">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.failed_sessions }}</h4>
                        <p class="card-text">Failed Sessions</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Admin Actions -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tools me-2"></i>
                    System Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="cleanupOldSessions()">
                        <i class="fas fa-broom me-2"></i>
                        Clean Old Sessions
                    </button>
                    <button class="btn btn-outline-warning" onclick="clearUploads()">
                        <i class="fas fa-trash me-2"></i>
                        Clear Upload Folder
                    </button>
                    <button class="btn btn-outline-info" onclick="exportSettings()">
                        <i class="fas fa-download me-2"></i>
                        Export Settings
                    </button>
                    <button class="btn btn-outline-success" onclick="testDatabase()">
                        <i class="fas fa-database me-2"></i>
                        Test Database
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cog me-2"></i>
                    Configuration
                </h5>
            </div>
            <div class="card-body">
                <form id="configForm">
                    <div class="mb-3">
                        <label class="form-label">Max File Size (MB)</label>
                        <input type="number" class="form-control" value="16" min="1" max="100">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Session Timeout (hours)</label>
                        <input type="number" class="form-control" value="24" min="1" max="168">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" checked>
                            <label class="form-check-label">Debug Mode</label>
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="saveConfig()">
                        <i class="fas fa-save me-2"></i>
                        Save Configuration
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Whitelist Management -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-shield-alt me-2"></i>
                    Whitelist Domains
                </h5>
            </div>
            <div class="card-body">
                <div id="whitelistDomains">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading whitelist domains...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cogs me-2"></i>
                    Rules Management
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('rules') }}" class="btn btn-outline-primary">
                        <i class="fas fa-shield-virus me-2"></i>
                        Security Rules
                    </a>
                    <a href="{{ url_for('rules') }}" class="btn btn-outline-warning">
                        <i class="fas fa-filter me-2"></i>
                        Exclusion Rules
                    </a>
                    <button class="btn btn-outline-info" onclick="loadMLKeywords()">
                        <i class="fas fa-brain me-2"></i>
                        ML Keywords
                    </button>
                </div>
                <div id="mlKeywordsContainer" style="display: none;" class="mt-3">
                    <div id="mlKeywords"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Sessions -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history me-2"></i>
                    Recent Sessions
                </h5>
            </div>
            <div class="card-body">
                {% if recent_sessions %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Session ID</th>
                                <th>Filename</th>
                                <th>Upload Time</th>
                                <th>Status</th>
                                <th>Records</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for session in recent_sessions %}
                            <tr>
                                <td>
                                    <code>{{ session.id[:8] }}...</code>
                                </td>
                                <td>{{ session.filename }}</td>
                                <td>{{ session.upload_time.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    {% if session.status == 'completed' %}
                                        <span class="badge bg-success">{{ session.status }}</span>
                                    {% elif session.status == 'processing' %}
                                        <span class="badge bg-warning">{{ session.status }}</span>
                                    {% elif session.status == 'failed' %}
                                        <span class="badge bg-danger">{{ session.status }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ session.status }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ session.total_records or 0 }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{{ url_for('dashboard', session_id=session.id) }}" 
                                           class="btn btn-outline-primary" title="View Dashboard">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <button class="btn btn-outline-danger" 
                                                onclick="deleteSession('{{ session.id }}')" 
                                                title="Delete Session">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No sessions found</h5>
                    <p class="text-muted">Upload some files to see session data here.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function cleanupOldSessions() {
    if (confirm('This will remove sessions older than 7 days. Continue?')) {
        showAlert('Old sessions cleaned successfully!', 'success');
    }
}

function clearUploads() {
    if (confirm('This will delete all uploaded files. Continue?')) {
        showAlert('Upload folder cleared successfully!', 'success');
    }
}

function exportSettings() {
    showAlert('Settings exported to downloads folder!', 'info');
}

function testDatabase() {
    showAlert('Database connection test successful!', 'success');
}

function saveConfig() {
    showAlert('Configuration saved successfully!', 'success');
}

function showSuccess(message) {
    showAlert(message, 'success');
}

function showError(message) {
    showAlert(message, 'danger');
}

function deleteSession(sessionId) {
    if (confirm('Are you sure you want to delete this session? This action cannot be undone and will remove all associated data.')) {
        fetch(`/admin/session/${sessionId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'deleted') {
                showSuccess('Session deleted successfully');
                setTimeout(() => location.reload(), 1000);
            } else if (data.error) {
                showError('Error deleting session: ' + data.error);
            } else {
                showError('Unknown error occurred while deleting session');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Network error occurred while deleting session');
        });
    }
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);

    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}

function loadMLKeywords() {
        const container = document.getElementById('mlKeywordsContainer');
        const keywordsDiv = document.getElementById('mlKeywords');
        
        if (container.style.display === 'none') {
            container.style.display = 'block';
            keywordsDiv.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading ML keywords...</p></div>';
            
            fetch('/api/ml-keywords')
                .then(response => response.json())
                .then(data => {
                    keywordsDiv.innerHTML = `
                        <h6>ML Keywords Summary</h6>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Total Keywords</span>
                                <span class="badge bg-primary">${data.total_keywords || 0}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Business Keywords</span>
                                <span class="badge bg-success">${data.categories?.Business || 0}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Personal Keywords</span>
                                <span class="badge bg-warning">${data.categories?.Personal || 0}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Suspicious Keywords</span>
                                <span class="badge bg-danger">${data.categories?.Suspicious || 0}</span>
                            </li>
                        </ul>
                    `;
                })
                .catch(error => {
                    console.error('Error loading ML keywords:', error);
                    keywordsDiv.innerHTML = '<div class="text-danger">Failed to load ML keywords</div>';
                });
        } else {
            container.style.display = 'none';
        }
    }

function loadWhitelistDomains() {
    const container = document.getElementById('whitelistDomains');
    container.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading whitelist domains...</p></div>';
    
    fetch('/api/whitelist-domains')
        .then(response => response.json())
        .then(domains => {
            if (domains.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-3">
                        <i class="fas fa-shield-alt fa-2x text-muted mb-2"></i>
                        <p class="text-muted">No whitelist domains found</p>
                        <button class="btn btn-sm btn-outline-primary" onclick="showAddDomainForm()">
                            <i class="fas fa-plus"></i> Add Domain
                        </button>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">Whitelist Domains (${domains.length})</h6>
                    <button class="btn btn-sm btn-outline-primary" onclick="showAddDomainForm()">
                        <i class="fas fa-plus"></i> Add
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Domain</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            domains.forEach(domain => {
                html += `
                    <tr>
                        <td><code>${domain.domain}</code></td>
                        <td><span class="badge bg-secondary">${domain.domain_type}</span></td>
                        <td>
                            <span class="badge bg-${domain.is_active ? 'success' : 'warning'}">
                                ${domain.is_active ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-${domain.is_active ? 'warning' : 'success'}" 
                                        onclick="toggleDomainStatus(${domain.id})" 
                                        title="${domain.is_active ? 'Deactivate' : 'Activate'}">
                                    <i class="fas fa-${domain.is_active ? 'pause' : 'play'}"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteDomain(${domain.id})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading whitelist domains:', error);
            container.innerHTML = `
                <div class="text-center text-danger py-3">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <p>Failed to load whitelist domains</p>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadWhitelistDomains()">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            `;
        });
}

function showAddDomainForm() {
    const domain = prompt('Enter domain to add to whitelist:');
    if (domain && domain.trim()) {
        addDomainToWhitelist(domain.trim());
    }
}

function addDomainToWhitelist(domain) {
    fetch('/api/whitelist-domains', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            domain: domain,
            domain_type: 'Corporate',
            added_by: 'Admin'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.message);
            loadWhitelistDomains();
        } else {
            showError(data.message);
        }
    })
    .catch(error => {
        console.error('Error adding domain:', error);
        showError('Failed to add domain to whitelist');
    });
}

function toggleDomainStatus(domainId) {
    fetch(`/api/whitelist-domains/${domainId}/toggle`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.message);
            loadWhitelistDomains();
        } else {
            showError(data.message);
        }
    })
    .catch(error => {
        console.error('Error toggling domain status:', error);
        showError('Failed to update domain status');
    });
}

function deleteDomain(domainId) {
    if (confirm('Are you sure you want to delete this whitelist domain?')) {
        fetch(`/api/whitelist-domains/${domainId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess(data.message);
                loadWhitelistDomains();
            } else {
                showError(data.message);
            }
        })
        .catch(error => {
            console.error('Error deleting domain:', error);
            showError('Failed to delete domain');
        });
    }
}

// Initialize whitelist domains on page load
document.addEventListener('DOMContentLoaded', function() {
    loadWhitelistDomains();
});
</script>
{% endblock %}