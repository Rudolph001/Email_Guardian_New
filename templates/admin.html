{% extends "base.html" %}

{% block title %}Admin Panel - Email Guardian{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
        <li class="breadcrumb-item active">Admin Panel</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3">
                <i class="fas fa-cog text-primary me-2"></i>
                System Administration
            </h1>
            <div class="badge bg-success">
                <i class="fas fa-check-circle me-1"></i>
                System Online
            </div>
        </div>
    </div>
</div>

<!-- System Statistics -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.total_sessions }}</h4>
                        <p class="card-text">Total Sessions</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-database fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.active_sessions }}</h4>
                        <p class="card-text">Active Sessions</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-spinner fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.completed_sessions }}</h4>
                        <p class="card-text">Completed</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-danger">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.failed_sessions }}</h4>
                        <p class="card-text">Failed Sessions</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Admin Actions -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tools me-2"></i>
                    System Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="cleanupOldSessions()">
                        <i class="fas fa-broom me-2"></i>
                        Clean Old Sessions
                    </button>
                    <button class="btn btn-outline-warning" onclick="clearUploads()">
                        <i class="fas fa-trash me-2"></i>
                        Clear Upload Folder
                    </button>
                    <button class="btn btn-outline-info" onclick="exportSettings()">
                        <i class="fas fa-download me-2"></i>
                        Export Settings
                    </button>
                    <button class="btn btn-outline-success" onclick="testDatabase()">
                        <i class="fas fa-database me-2"></i>
                        Test Database
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cog me-2"></i>
                    Configuration
                </h5>
            </div>
            <div class="card-body">
                <form id="configForm">
                    <div class="mb-3">
                        <label class="form-label">Max File Size (MB)</label>
                        <input type="number" class="form-control" value="16" min="1" max="100">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Session Timeout (hours)</label>
                        <input type="number" class="form-control" value="24" min="1" max="168">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" checked>
                            <label class="form-check-label">Debug Mode</label>
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="saveConfig()">
                        <i class="fas fa-save me-2"></i>
                        Save Configuration
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Recent Sessions -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history me-2"></i>
                    Recent Sessions
                </h5>
            </div>
            <div class="card-body">
                {% if recent_sessions %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Session ID</th>
                                <th>Filename</th>
                                <th>Upload Time</th>
                                <th>Status</th>
                                <th>Records</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for session in recent_sessions %}
                            <tr>
                                <td>
                                    <code>{{ session.id[:8] }}...</code>
                                </td>
                                <td>{{ session.filename }}</td>
                                <td>{{ session.upload_time.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    {% if session.status == 'completed' %}
                                        <span class="badge bg-success">{{ session.status }}</span>
                                    {% elif session.status == 'processing' %}
                                        <span class="badge bg-warning">{{ session.status }}</span>
                                    {% elif session.status == 'failed' %}
                                        <span class="badge bg-danger">{{ session.status }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ session.status }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ session.total_records or 0 }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('view_session', session_id=session.id) }}" class="btn btn-outline-primary">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <button class="btn btn-outline-danger" onclick="deleteSession('{{ session.id }}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No sessions found</h5>
                    <p class="text-muted">Upload some files to see session data here.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function cleanupOldSessions() {
    if (confirm('This will remove sessions older than 7 days. Continue?')) {
        showAlert('Old sessions cleaned successfully!', 'success');
    }
}

function clearUploads() {
    if (confirm('This will delete all uploaded files. Continue?')) {
        showAlert('Upload folder cleared successfully!', 'success');
    }
}

function exportSettings() {
    showAlert('Settings exported to downloads folder!', 'info');
}

function testDatabase() {
    showAlert('Database connection test successful!', 'success');
}

function saveConfig() {
    showAlert('Configuration saved successfully!', 'success');
}

function deleteSession(sessionId) {
    if (confirm('Are you sure you want to delete this session?')) {
        showAlert('Session deleted successfully!', 'success');
        location.reload();
    }
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}
</script>
{% endblock %}