{% extends "base.html" %}

{% block title %}Rules Management{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active">Rules</li>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h2">
                    <i class="fas fa-gavel text-primary"></i>
                    Rules Management
                </h1>
                <p class="text-muted">Configure security rules and exclusion filters for email processing</p>
            </div>
            <div>
                <button class="btn btn-primary" onclick="createNewRule()">
                    <i class="fas fa-plus"></i> Create Rule
                </button>
                <button class="btn btn-outline-secondary" onclick="importRules()">
                    <i class="fas fa-upload"></i> Import
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Rule Statistics -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6">
        <div class="card text-center border-primary">
            <div class="card-body">
                <i class="fas fa-shield-alt fa-2x text-primary mb-2"></i>
                <h4>{{ security_rules|length }}</h4>
                <p class="text-muted mb-0">Security Rules</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card text-center border-warning">
            <div class="card-body">
                <i class="fas fa-filter fa-2x text-warning mb-2"></i>
                <h4>{{ exclusion_rules|length }}</h4>
                <p class="text-muted mb-0">Exclusion Rules</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card text-center border-success">
            <div class="card-body">
                <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                <h4>{{ (security_rules + exclusion_rules)|selectattr('is_active')|list|length }}</h4>
                <p class="text-muted mb-0">Active Rules</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card text-center border-info">
            <div class="card-body">
                <i class="fas fa-sort-numeric-up fa-2x text-info mb-2"></i>
                <h4>{{ ((security_rules + exclusion_rules)|map(attribute='priority')|sum) if (security_rules + exclusion_rules) else 0 }}</h4>
                <p class="text-muted mb-0">Total Priority</p>
            </div>
        </div>
    </div>
</div>

<!-- Rules Tabs -->
<div class="card">
    <div class="card-header">
        <ul class="nav nav-tabs card-header-tabs" id="rulesTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="security-rules-tab" data-bs-toggle="tab" data-bs-target="#security-rules" type="button" role="tab">
                    <i class="fas fa-shield-alt"></i> Security Rules
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="exclusion-rules-tab" data-bs-toggle="tab" data-bs-target="#exclusion-rules" type="button" role="tab">
                    <i class="fas fa-filter"></i> Exclusion Rules
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="rule-builder-tab" data-bs-toggle="tab" data-bs-target="#rule-builder" type="button" role="tab">
                    <i class="fas fa-tools"></i> Rule Builder
                </button>
            </li>
        </ul>
    </div>
    <div class="card-body">
        <div class="tab-content" id="rulesTabsContent">
            <!-- Security Rules Tab -->
            <div class="tab-pane fade show active" id="security-rules" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Security Rules</h5>
                    <div>
                        <button class="btn btn-outline-primary btn-sm" onclick="testAllRules('security')">
                            <i class="fas fa-vial"></i> Test All
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="exportRules('security')">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                
                {% if security_rules %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Priority</th>
                                <th>Conditions</th>
                                <th>Actions</th>
                                <th>Status</th>
                                <th>Operations</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for rule in security_rules %}
                            <tr>
                                <td>
                                    <strong>{{ rule.name }}</strong>
                                    <br><small class="text-muted">ID: {{ rule.id }}</small>
                                </td>
                                <td>{{ rule.description[:100] }}{% if rule.description|length > 100 %}...{% endif %}</td>
                                <td>
                                    <span class="badge bg-{% if rule.priority >= 5 %}danger{% elif rule.priority >= 3 %}warning{% else %}info{% endif %}">
                                        {{ rule.priority }}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-info" onclick="viewConditions({{ rule.id }})">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                </td>
                                <td>
                                    {% if rule.actions %}
                                        {% set actions = rule.actions if rule.actions is mapping else {} %}
                                        {% for action, value in actions.items() %}
                                            <span class="badge bg-secondary">{{ action }}</span>
                                        {% endfor %}
                                    {% else %}
                                        <span class="text-muted">None</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if rule.is_active %}
                                        <span class="badge bg-success">Active</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Inactive</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-primary" onclick="editRule({{ rule.id }})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-info" onclick="testRule({{ rule.id }})">
                                            <i class="fas fa-vial"></i>
                                        </button>
                                        <button class="btn btn-outline-{% if rule.is_active %}warning{% else %}success{% endif %}" 
                                                onclick="toggleRule({{ rule.id }})">
                                            <i class="fas fa-{% if rule.is_active %}pause{% else %}play{% endif %}"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteRule({{ rule.id }})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-shield-alt fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No Security Rules</h5>
                    <p class="text-muted">Create your first security rule to start detecting threats.</p>
                    <button class="btn btn-primary" onclick="createNewRule('security')">
                        <i class="fas fa-plus"></i> Create Security Rule
                    </button>
                </div>
                {% endif %}
            </div>

            <!-- Exclusion Rules Tab -->
            <div class="tab-pane fade" id="exclusion-rules" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Exclusion Rules</h5>
                    <div>
                        <button class="btn btn-outline-primary btn-sm" onclick="testAllRules('exclusion')">
                            <i class="fas fa-vial"></i> Test All
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="exportRules('exclusion')">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                
                {% if exclusion_rules %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Priority</th>
                                <th>Conditions</th>
                                <th>Impact</th>
                                <th>Status</th>
                                <th>Operations</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for rule in exclusion_rules %}
                            <tr>
                                <td>
                                    <strong>{{ rule.name }}</strong>
                                    <br><small class="text-muted">ID: {{ rule.id }}</small>
                                </td>
                                <td>{{ rule.description[:100] }}{% if rule.description|length > 100 %}...{% endif %}</td>
                                <td>
                                    <span class="badge bg-{% if rule.priority >= 5 %}danger{% elif rule.priority >= 3 %}warning{% else %}info{% endif %}">
                                        {{ rule.priority }}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-info" onclick="viewConditions({{ rule.id }})">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-warning" onclick="showImpact({{ rule.id }})">
                                        <i class="fas fa-chart-bar"></i> Impact
                                    </button>
                                </td>
                                <td>
                                    {% if rule.is_active %}
                                        <span class="badge bg-success">Active</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Inactive</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-primary" onclick="editRule({{ rule.id }})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-info" onclick="testRule({{ rule.id }})">
                                            <i class="fas fa-vial"></i>
                                        </button>
                                        <button class="btn btn-outline-{% if rule.is_active %}warning{% else %}success{% endif %}" 
                                                onclick="toggleRule({{ rule.id }})">
                                            <i class="fas fa-{% if rule.is_active %}pause{% else %}play{% endif %}"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteRule({{ rule.id }})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-filter fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No Exclusion Rules</h5>
                    <p class="text-muted">Create exclusion rules to filter out unwanted records before processing.</p>
                    <button class="btn btn-primary" onclick="createNewRule('exclusion')">
                        <i class="fas fa-plus"></i> Create Exclusion Rule
                    </button>
                </div>
                {% endif %}
            </div>

            <!-- Rule Builder Tab -->
            <div class="tab-pane fade" id="rule-builder" role="tabpanel">
                <div class="row">
                    <div class="col-lg-8">
                        <h5>Visual Rule Builder</h5>
                        <form id="ruleBuilderForm">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">Rule Information</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="ruleName" class="form-label">Rule Name *</label>
                                                <input type="text" class="form-control" id="ruleName" required>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="ruleType" class="form-label">Rule Type *</label>
                                                <select class="form-select" id="ruleType" required>
                                                    <option value="">Select type...</option>
                                                    <option value="security">Security Rule</option>
                                                    <option value="exclusion">Exclusion Rule</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="rulePriority" class="form-label">Priority</label>
                                                <input type="number" class="form-control" id="rulePriority" min="1" max="10" value="3">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="ruleDescription" class="form-label">Description</label>
                                        <textarea class="form-control" id="ruleDescription" rows="2" 
                                                  placeholder="Describe what this rule does..."></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mt-3">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="card-title mb-0">Conditions</h6>
                                        <div>
                                            <select class="form-select form-select-sm d-inline-block w-auto" id="conditionLogic">
                                                <option value="AND">AND (All conditions must match)</option>
                                                <option value="OR">OR (Any condition can match)</option>
                                            </select>
                                            <button type="button" class="btn btn-sm btn-outline-primary ms-2" onclick="addCondition()">
                                                <i class="fas fa-plus"></i> Add Condition
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="conditionsContainer">
                                        <!-- Conditions will be added here dynamically -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mt-3" id="actionsCard" style="display: none;">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">Actions (Security Rules Only)</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="actionEscalate">
                                                <label class="form-check-label" for="actionEscalate">
                                                    Auto-escalate
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="actionFlag">
                                                <label class="form-check-label" for="actionFlag">
                                                    Flag case
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="scoreModifier" class="form-label">Score Modifier</label>
                                                <input type="number" class="form-control form-control-sm" id="scoreModifier" 
                                                       step="0.1" min="-1" max="1" placeholder="0.0">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="actionTag" class="form-label">Add Tag</label>
                                                <input type="text" class="form-control form-control-sm" id="actionTag" 
                                                       placeholder="Tag name">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center mt-4">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save"></i> Save Rule
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="testBuiltRule()">
                                    <i class="fas fa-vial"></i> Test Rule
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="clearRuleBuilder()">
                                    <i class="fas fa-eraser"></i> Clear
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">Available Fields</h6>
                            </div>
                            <div class="card-body">
                                <div class="list-group list-group-flush">
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <code>sender</code>
                                        <span class="badge bg-primary">Email</span>
                                    </div>
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <code>subject</code>
                                        <span class="badge bg-primary">Text</span>
                                    </div>
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <code>attachments</code>
                                        <span class="badge bg-primary">Text</span>
                                    </div>
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <code>recipients_email_domain</code>
                                        <span class="badge bg-primary">Domain</span>
                                    </div>
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <code>leaver</code>
                                        <span class="badge bg-warning">Boolean</span>
                                    </div>
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <code>department</code>
                                        <span class="badge bg-info">Category</span>
                                    </div>
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <code>justification</code>
                                        <span class="badge bg-primary">Text</span>
                                    </div>
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <code>wordlist_attachment</code>
                                        <span class="badge bg-danger">Keywords</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="card-title mb-0">Operators</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6">
                                        <ul class="list-unstyled">
                                            <li><code>equals</code></li>
                                            <li><code>contains</code></li>
                                            <li><code>starts_with</code></li>
                                            <li><code>ends_with</code></li>
                                        </ul>
                                    </div>
                                    <div class="col-6">
                                        <ul class="list-unstyled">
                                            <li><code>not_equals</code></li>
                                            <li><code>in_list</code></li>
                                            <li><code>matches_pattern</code></li>
                                            <li><code>is_empty</code></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Rule Details Modal -->
<div class="modal fade" id="ruleDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Rule Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="ruleDetailsBody">
                <!-- Rule details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let conditionCounter = 0;

// Show/hide actions card based on rule type
document.getElementById('ruleType').addEventListener('change', function() {
    const actionsCard = document.getElementById('actionsCard');
    if (this.value === 'security') {
        actionsCard.style.display = 'block';
    } else {
        actionsCard.style.display = 'none';
    }
});

// Add condition to rule builder
function addCondition() {
    conditionCounter++;
    const container = document.getElementById('conditionsContainer');
    
    const conditionHtml = `
        <div class="rule-condition" id="condition-${conditionCounter}">
            <div class="rule-condition-header">
                <span class="fw-bold">Condition ${conditionCounter}</span>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeCondition(${conditionCounter})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <select class="form-select" name="field-${conditionCounter}" required>
                        <option value="">Select field...</option>
                        <option value="sender">Sender</option>
                        <option value="subject">Subject</option>
                        <option value="attachments">Attachments</option>
                        <option value="recipients_email_domain">Recipient Domain</option>
                        <option value="leaver">Leaver</option>
                        <option value="department">Department</option>
                        <option value="justification">Justification</option>
                        <option value="wordlist_attachment">Wordlist Attachment</option>
                        <option value="wordlist_subject">Wordlist Subject</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" name="operator-${conditionCounter}" required>
                        <option value="">Select operator...</option>
                        <option value="equals">Equals</option>
                        <option value="contains">Contains</option>
                        <option value="not_equals">Not Equals</option>
                        <option value="starts_with">Starts With</option>
                        <option value="ends_with">Ends With</option>
                        <option value="in_list">In List</option>
                        <option value="matches_pattern">Matches Pattern (Regex)</option>
                        <option value="is_empty">Is Empty</option>
                        <option value="is_not_empty">Is Not Empty</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="text" class="form-control" name="value-${conditionCounter}" 
                           placeholder="Condition value...">
                </div>
                <div class="col-md-1">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="case-sensitive-${conditionCounter}">
                        <label class="form-check-label" title="Case Sensitive">
                            Aa
                        </label>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', conditionHtml);
}

function removeCondition(id) {
    const condition = document.getElementById(`condition-${id}`);
    if (condition) {
        condition.remove();
    }
}

// Rule builder form submission
document.getElementById('ruleBuilderForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const ruleName = document.getElementById('ruleName').value;
    const ruleType = document.getElementById('ruleType').value;
    
    if (!ruleName || !ruleType) {
        showError('Please fill in required fields');
        return;
    }
    
    // Collect conditions
    const conditions = [];
    const conditionsContainer = document.getElementById('conditionsContainer');
    const conditionElements = conditionsContainer.querySelectorAll('.rule-condition');
    
    conditionElements.forEach(element => {
        const id = element.id.split('-')[1];
        const field = element.querySelector(`[name="field-${id}"]`).value;
        const operator = element.querySelector(`[name="operator-${id}"]`).value;
        const value = element.querySelector(`[name="value-${id}"]`).value;
        const caseSensitive = element.querySelector(`[name="case-sensitive-${id}"]`).checked;
        
        if (field && operator) {
            conditions.push({
                field: field,
                operator: operator,
                value: value,
                case_sensitive: caseSensitive
            });
        }
    });
    
    if (conditions.length === 0) {
        showError('Please add at least one condition');
        return;
    }
    
    // Collect actions (for security rules)
    const actions = {};
    if (ruleType === 'security') {
        if (document.getElementById('actionEscalate').checked) {
            actions.escalate = true;
        }
        if (document.getElementById('actionFlag').checked) {
            actions.flag = true;
        }
        const scoreModifier = document.getElementById('scoreModifier').value;
        if (scoreModifier) {
            actions.score_modifier = parseFloat(scoreModifier);
        }
        const tag = document.getElementById('actionTag').value;
        if (tag) {
            actions.tag = tag;
        }
    }
    
    // Build rule object
    const ruleData = {
        name: ruleName,
        description: document.getElementById('ruleDescription').value,
        rule_type: ruleType,
        priority: parseInt(document.getElementById('rulePriority').value),
        conditions: {
            logic: document.getElementById('conditionLogic').value,
            conditions: conditions
        },
        actions: actions
    };
    
    // Submit rule
    showLoading('Creating rule...');
    
    // Simulate rule creation
    setTimeout(() => {
        hideLoading();
        showSuccess(`Rule "${ruleName}" created successfully`);
        clearRuleBuilder();
        setTimeout(() => location.reload(), 1500);
    }, 2000);
});

function clearRuleBuilder() {
    document.getElementById('ruleBuilderForm').reset();
    document.getElementById('conditionsContainer').innerHTML = '';
    document.getElementById('actionsCard').style.display = 'none';
    conditionCounter = 0;
}

function testBuiltRule() {
    const conditions = [];
    const conditionsContainer = document.getElementById('conditionsContainer');
    const conditionElements = conditionsContainer.querySelectorAll('.rule-condition');
    
    if (conditionElements.length === 0) {
        showError('Please add conditions before testing');
        return;
    }
    
    showLoading('Testing rule...');
    
    // Simulate rule testing
    setTimeout(() => {
        hideLoading();
        showSuccess('Rule test completed - 0 matches found in sample data');
    }, 1500);
}

// Rule management functions
function createNewRule(type = '') {
    // Switch to rule builder tab
    const ruleBuilderTab = document.getElementById('rule-builder-tab');
    ruleBuilderTab.click();
    
    // Set rule type if provided
    if (type) {
        document.getElementById('ruleType').value = type;
        document.getElementById('ruleType').dispatchEvent(new Event('change'));
    }
    
    // Focus on rule name
    setTimeout(() => {
        document.getElementById('ruleName').focus();
    }, 100);
}

function editRule(ruleId) {
    showLoading('Loading rule...');
    
    // Simulate loading rule data
    setTimeout(() => {
        hideLoading();
        showSuccess('Edit functionality would be implemented here');
    }, 1000);
}

function viewConditions(ruleId) {
    // Load and display rule conditions
    const modalBody = document.getElementById('ruleDetailsBody');
    modalBody.innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading rule details...</p>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('ruleDetailsModal'));
    modal.show();
    
    // Simulate loading
    setTimeout(() => {
        modalBody.innerHTML = `
            <h6>Rule Conditions</h6>
            <div class="alert alert-info">
                Rule details would be displayed here in a real implementation.
            </div>
        `;
    }, 1000);
}

function testRule(ruleId) {
    showLoading('Testing rule...');
    
    setTimeout(() => {
        hideLoading();
        showSuccess('Rule test completed');
    }, 1500);
}

function toggleRule(ruleId) {
    showLoading('Updating rule status...');
    
    setTimeout(() => {
        hideLoading();
        showSuccess('Rule status updated');
        location.reload();
    }, 1000);
}

function deleteRule(ruleId) {
    if (confirm('Are you sure you want to delete this rule?')) {
        showLoading('Deleting rule...');
        
        setTimeout(() => {
            hideLoading();
            showSuccess('Rule deleted successfully');
            location.reload();
        }, 1000);
    }
}

function testAllRules(type) {
    showLoading(`Testing all ${type} rules...`);
    
    setTimeout(() => {
        hideLoading();
        showSuccess(`All ${type} rules tested successfully`);
    }, 2000);
}

function exportRules(type) {
    showLoading(`Exporting ${type} rules...`);
    
    setTimeout(() => {
        hideLoading();
        showSuccess(`${type} rules exported successfully`);
    }, 1000);
}

function importRules() {
    // Simulate file upload
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = function() {
        if (this.files.length > 0) {
            showLoading('Importing rules...');
            setTimeout(() => {
                hideLoading();
                showSuccess('Rules imported successfully');
                location.reload();
            }, 2000);
        }
    };
    input.click();
}

function showImpact(ruleId) {
    showLoading('Analyzing rule impact...');
    
    setTimeout(() => {
        hideLoading();
        showSuccess('Impact analysis completed');
    }, 1500);
}

// Add first condition by default
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        addCondition();
    }, 100);
});
</script>
{% endblock %}
